<!DOCTYPE html>
<html>

<head>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script
        src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <script
        src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">
    <a-scene vr-mode-ui="enabled: false;" loading-screen="enabled: false;"
        renderer="logarithmicDepthBuffer: true; preserveDrawingBuffer: true;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;" id="scene" embedded gesture-detector>

        <a-assets>
            <a-asset-item id="animated-asset" src="assets/asset.gltf"></a-asset-item>
        </a-assets>

        <a-marker id="animated-marker" type="pattern" preset="custom" url="assets/marker.patt"
            raycaster="objects: .clickable" emitevents="true" cursor="fuse: false; rayOrigin: mouse;" id="markerA">
            <a-entity id="bowser-model" scale="0.002119628117280293 0.002119628117280293 0.002119628117280293"
                animation-mixer="loop: repeat" gltf-model="#animated-asset" class="clickable"
                gesture-handler></a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <button id="screenshotButton"
        style="position: absolute; top: 10px; right: 10px; z-index: 1000; padding: 10px; background: white; border: none; cursor: pointer;">
        Take Screenshot
    </button>

    <script>
        const scene = document.querySelector('a-scene');
        scene.addEventListener('loaded', function () {
            console.log("Scene loaded, setting up screenshot button.");

            const screenshotButton = document.getElementById('screenshotButton');
            screenshotButton.addEventListener('click', takeScreenshot);


            function takeScreenshot() {
                try {
                    const renderer = scene.renderer;
                    const video = document.querySelector('video');

                    if (!renderer) {
                        throw new Error("Renderer not initialized.");
                    }

                    const arCanvas = renderer.domElement; // Get AR.js canvas
                    const aspectRatio = arCanvas.width / arCanvas.height; // Get canvas aspect ratio

                    // Create a temporary canvas with the same aspect ratio as AR.js canvas
                    const tempCanvas = document.createElement('canvas');
                    
                    tempCanvas.width = window.screen.width;
                    tempCanvas.height = window.screen.height;; // Maintain AR scene's aspect ratio
                    const tempCtx = tempCanvas.getContext('2d');

                    if (video) {
                        tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
                    }

                    // Render AR content and overlay it
                    renderer.render(scene.object3D, scene.camera);
                    tempCtx.drawImage(arCanvas, 0, 0, tempCanvas.width, tempCanvas.height);

                    // Generate and download the screenshot
                    const imgData = tempCanvas.toDataURL('image/png');
                    downloadImage(imgData);

                } catch (error) {
                    console.error("Error taking screenshot:", error);
                    alert("Failed to take screenshot. Check the console for details.");
                }
            }


            function downloadImage(imgData) {
                const link = document.createElement('a');
                link.href = imgData;
                link.download = 'screenshot.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        scene.addEventListener('loaderror', function (event) {
            console.error("Scene failed to load:", event);
        });
    </script>
</body>

</html>