<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">
    <a-scene vr-mode-ui="enabled: false;" loading-screen="enabled: false;"
        renderer="logarithmicDepthBuffer: true; preserveDrawingBuffer: true;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;" id="scene" embedded gesture-detector>

        <a-assets>
            <a-asset-item id="animated-asset" src="assets/asset.gltf"></a-asset-item>
        </a-assets>

        <a-marker id="animated-marker" type="pattern" preset="custom" url="assets/marker.patt"
            raycaster="objects: .clickable" emitevents="true" cursor="fuse: false; rayOrigin: mouse;" id="markerA">
            <a-entity id="bowser-model" scale="0.002119628117280293 0.002119628117280293 0.002119628117280293"
                animation-mixer="loop: repeat" gltf-model="#animated-asset" class="clickable"
                gesture-handler></a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <button id="recordButton"
        style="position: absolute; top: 10px; right: 70px; z-index: 1000; padding: 10px; background: white; border: none; cursor: pointer;">
        Start Recording
    </button>
    <button id="shareButton" disabled
        style="position: absolute; top: 10px; right: 10px; z-index: 1000; padding: 10px; background: white; border: none; cursor: pointer;">
        Share
    </button>

    <script>
        const scene = document.querySelector('a-scene');
        let lastVideoBlob = null;
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;

        scene.addEventListener('loaded', function () {
            console.log("Scene loaded, setting up buttons.");

            const recordButton = document.getElementById('recordButton');
            const shareButton = document.getElementById('shareButton');

            recordButton.addEventListener('click', toggleRecording);
            shareButton.addEventListener('click', shareVideo);

            async function toggleRecording() {
                if (!isRecording) {
                    startRecording();
                } else {
                    stopRecording();
                }
            }

            async function startRecording() {
                try {
                    const renderer = scene.renderer;
                    const video = document.querySelector('video');
                    const arCanvas = renderer.domElement;

                    if (!renderer || !video) {
                        throw new Error("Required elements not initialized.");
                    }

                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCanvas.width = arCanvas.width;
                    tempCanvas.height = arCanvas.height;

                    const canvasStream = tempCanvas.captureStream(30);

                    recordedChunks = [];
                    mediaRecorder = new MediaRecorder(canvasStream, { mimeType: 'video/webm' });
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        lastVideoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                        downloadVideo(lastVideoBlob);
                        shareButton.disabled = false;
                    };

                    function animate() {
                        if (mediaRecorder.state === 'recording') {
                            tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
                            renderer.render(scene.object3D, scene.camera);
                            tempCtx.drawImage(arCanvas, 0, 0, tempCanvas.width, tempCanvas.height);
                            requestAnimationFrame(animate);
                        }
                    }

                    mediaRecorder.start();
                    isRecording = true;
                    recordButton.textContent = 'Stop Recording';
                    animate();

                } catch (error) {
                    console.error("Error starting recording:", error);
                    alert("Failed to start recording. Check the console for details.");
                    isRecording = false;
                    recordButton.textContent = 'Start Recording';
                }
            }

            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    isRecording = false;
                    recordButton.textContent = 'Start Recording';
                }
            }

            function shareVideo() {
                if (!lastVideoBlob) {
                    alert("No video available to share. Record a video first!");
                    return;
                }

                if (!navigator.share) {
                    alert("Sharing is not supported in this browser. Use the downloaded video instead.");
                    return;
                }

                const file = new File([lastVideoBlob], 'ar-video.webm', { type: 'video/webm' });
                const shareData = {
                    files: [file],
                    title: 'AR Video',
                    text: 'Check out my AR video recording!'
                };

                navigator.share(shareData)
                    .then(() => console.log("Video shared successfully!"))
                    .catch(err => {
                        console.error("Error sharing video:", err);
                        alert("Failed to share. Use the downloaded video instead.");
                    });
            }

            function downloadVideo(blob) {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'ar-video.webm';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        });

        scene.addEventListener('loaderror', function (event) {
            console.error("Scene failed to load:", event);
        });
    </script>
</body>
</html>