<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">
    <a-scene vr-mode-ui="enabled: false;" loading-screen="enabled: false;"
        renderer="logarithmicDepthBuffer: true; preserveDrawingBuffer: true;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;" id="scene" embedded gesture-detector>

        <a-assets>
            <a-asset-item id="animated-asset" src="assets/asset.gltf"></a-asset-item>
        </a-assets>

        <a-marker id="animated-marker" type="pattern" preset="custom" url="assets/marker.patt"
            raycaster="objects: .clickable" emitevents="true" cursor="fuse: false; rayOrigin: mouse;" id="markerA">
            <a-entity id="bowser-model" scale="0.002119628117280293 0.002119628117280293 0.002119628117280293"
                animation-mixer="loop: repeat" gltf-model="#animated-asset" class="clickable"
                gesture-handler></a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <button id="screenshotButton"
        style="position: absolute; top: 10px; right: 70px; z-index: 1000; padding: 10px; background: white; border: none; cursor: pointer;">
        Take Screenshot
    </button>
    <button id="shareButton" disabled
        style="position: absolute; top: 10px; right: 10px; z-index: 1000; padding: 10px; background: white; border: none; cursor: pointer;">
        Share
    </button>

    <script>
        const scene = document.querySelector('a-scene');
        let lastScreenshotData = null; // Store the last screenshot for sharing

        scene.addEventListener('loaded', function () {
            console.log("Scene loaded, setting up buttons.");

            const screenshotButton = document.getElementById('screenshotButton');
            const shareButton = document.getElementById('shareButton');

            screenshotButton.addEventListener('click', takeScreenshot);
            shareButton.addEventListener('click', shareScreenshot);

            function takeScreenshot() {
                try {
                    const renderer = scene.renderer;
                    const video = document.querySelector('video');

                    if (!renderer) {
                        throw new Error("Renderer not initialized.");
                    }

                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    const arCanvas = renderer.domElement;

                    tempCanvas.width = arCanvas.width;
                    tempCanvas.height = arCanvas.height;

                    if (video) {
                        tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
                    } else {
                        console.warn("Video feed not found, capturing AR content only.");
                    }

                    renderer.render(scene.object3D, scene.camera);
                    tempCtx.drawImage(arCanvas, 0, 0, tempCanvas.width, tempCanvas.height);

                    const imgData = tempCanvas.toDataURL('image/png');
                    lastScreenshotData = imgData; // Store for sharing
                    downloadImage(imgData);

                    // Enable the share button after a screenshot is taken
                    shareButton.disabled = false;

                } catch (error) {
                    console.error("Error taking screenshot:", error);
                    alert("Failed to take screenshot. Check the console for details.");
                }
            }

            function shareScreenshot() {
                if (!lastScreenshotData) {
                    alert("No screenshot available to share. Take a screenshot first!");
                    return;
                }

                if (!navigator.share) {
                    alert("Sharing is not supported in this browser. Use the downloaded image instead.");
                    return;
                }

                // Convert data URL to blob
                fetch(lastScreenshotData)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], 'screenshot.png', { type: 'image/png' });
                        const shareData = {
                            files: [file],
                            title: 'AR Screenshot',
                            text: 'Check out my AR screenshot!'
                        };

                        navigator.share(shareData)
                            .then(() => console.log("Screenshot shared successfully!"))
                            .catch(err => {
                                console.error("Error sharing screenshot:", err);
                                alert("Failed to share. Use the downloaded image instead.");
                            });
                    })
                    .catch(err => {
                        console.error("Error converting image to blob:", err);
                        alert("Failed to prepare image for sharing.");
                    });
            }

            function downloadImage(imgData) {
                const link = document.createElement('a');
                link.href = imgData;
                link.download = 'screenshot.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        scene.addEventListener('loaderror', function (event) {
            console.error("Scene failed to load:", event);
        });
    </script>
</body>
</html>